# æ—¶é—´ç‰‡è½®è¯¢çš„ä»»åŠ¡è°ƒåº¦æ–¹æ³•ï¼ˆäºŒï¼‰

## è°ƒåº¦å™¨è®¾è®¡æ€è·¯
åœ¨[ä¸Šç¯‡æ–‡ç« æœ«](./åŸºäºæ—¶é—´ç‰‡çš„ä»»åŠ¡è°ƒåº¦(ä¸€).md)ï¼Œå¯¹æ—¶é—´è°ƒåº¦çš„åŸºæœ¬ç»“æ„è¿›è¡ŒæŠ½è±¡ã€‚
ä¸€ä¸ªæ—¶é—´ç‰‡è½®è¯¢ä»»åŠ¡è°ƒåº¦å™¨ï¼ˆå®šæ—¶å™¨è°ƒåº¦ï¼‰ï¼ŒåŒ…æ‹¬ä»»åŠ¡å‡½æ•°(```func```)ã€ä»»åŠ¡æ‰§è¡Œé—´éš”(```interval```)ã€ä¸Šæ¬¡æ‰§è¡Œæ—¶é—´(```last_time```)ä¸‰ä¸ªæ ¸å¿ƒå‚æ•°ã€‚

ç„¶åå°†æ‰€æœ‰å¾…æ‰§è¡Œçš„ä»»åŠ¡èŠ‚ç‚¹(```time_node```)æ”¾åˆ°ä»»åŠ¡é“¾è¡¨ä¸­ã€‚

ç”±ä¸Šé¢çš„å‡ ä¸ªå‚æ•°ç»„æˆäº†è°ƒåº¦å™¨çš„æ•°æ®ç»“æ„ï¼š
```c
struct time_task
{
    uint32_t last_time;     //ä¸Šæ¬¡æ‰§è¡Œæ—¶é—´
    uint32_t interval;      //æ‰§è¡Œé—´éš”
    void *para;             //ä»»åŠ¡å‚æ•°
    void (*func)(void * arg);   //ä»»åŠ¡å‡½æ•°
    enum TIME_MODE flag;        //æ‰§è¡Œæ¨¡å¼
    struct list_head time_node; //é“¾è¡¨èŠ‚ç‚¹
};

```

### æ³¨å†Œä»»åŠ¡
å½“å¼€å§‹ä¸€ä¸ªä»»åŠ¡æ—¶ï¼Œé¦–å…ˆæ³¨å†Œä¸€ä¸ªä»»åŠ¡èŠ‚ç‚¹ï¼Œå°†ç›¸å…³ä¿¡æ¯æ·»åŠ åˆ°èŠ‚ç‚¹ä¸­ã€‚
åœ¨ä»£ç ä¸­å…·ä½“å®ç°ä¸ºï¼Œç”³è¯·ä¸€å—å†…å­˜ä¿å­˜ä»»åŠ¡ä¿¡æ¯ï¼ˆ```struct time_task```ï¼‰:
```c
/*æ³¨å†Œä»»åŠ¡ï¼Œåˆ›å»ºç»“æ„ä½“è¿›è¡Œèµ‹å€¼*/
time_task_t time_task_register(uint32_t interval, void (*func)(void *arg), void *para, TIME_MODE flag)
{
    assert(func);

    time_task_t task = malloc(sizeof(struct time_task));
    task->flag = flag;
    task->func = func;
    task->interval = interval;
    task->para = para;

    return task;
}
```

ä¿å­˜å®Œä»»åŠ¡ä¿¡æ¯åï¼Œæ·»åŠ ä»»åŠ¡èŠ‚ç‚¹åˆ°é“¾è¡¨ï¼Œé“¾è¡¨ç”¨äºä¿å­˜æ‰€æœ‰å¾…æ‰§è¡Œçš„ä»»åŠ¡ã€‚åœ¨ä»»åŠ¡é“¾è¡¨ä¸­æ ¹æ®å¾…æ‰§è¡Œçš„å…ˆåé¡ºåºæ’åˆ—ã€‚
å³å°†æ‰§è¡Œçš„ä»»åŠ¡èŠ‚ç‚¹ä¸ºäºé“¾è¡¨å¤´ï¼Œåœ¨æ‰§è¡Œæ—¶æ°¸è¿œæ‰§è¡Œç¬¬ä¸€ä¸ªä»»åŠ¡èŠ‚ç‚¹ã€‚
```c
/*è®¡ç®—ä¸‹ä¸€æ¬¡æ‰§è¡Œæ—¶é—´ï¼Œå°†ä»»åŠ¡åŠ å…¥åˆ°å¾…æ‰§è¡Œä»»åŠ¡åˆ—è¡¨*/
void time_task_start(time_task_t task, uint32_t start_time)
{
    task->last_time =  start_time + millis();
    
    /*æ’å…¥ä»»åŠ¡åˆ°é“¾è¡¨ï¼ŒæŒ‰æ‰§è¡Œæ—¶é—´å…ˆåæ’åˆ—ï¼Œä¾æ¬¡é€’å¢*/
    time_node_insert(task);
}
```

## ä»»åŠ¡è°ƒåº¦
åœ¨ç³»ç»Ÿåˆå§‹åŒ–æ—¶æ³¨å†Œä»»åŠ¡åˆ°é“¾è¡¨ï¼Œç„¶ååœ¨ä¸»å¾ªç¯ä¸­è¿è¡Œè°ƒåº¦å™¨ã€‚ç”±è°ƒåº¦å™¨æŸ¥æ‰¾å¾…æ‰§è¡Œçš„ä»»åŠ¡ï¼Œç®€åŒ–ä»£ç ã€‚
åœ¨ä»»åŠ¡è°ƒåº¦å‡½æ•°ä¸­ï¼Œè¿›è¡Œåˆ¤æ–­å½“å‰æ˜¯å¦æœ‰ä»»åŠ¡å¾…æ‰§è¡Œï¼Œå¦‚æœæœ‰ä»»åŠ¡å¾…æ‰§è¡Œï¼Œåˆ™æ‰§è¡Œä»»åŠ¡ï¼Œå¦åˆ™è¿”å›ã€‚
```c
void time_task_schedule(void)
{
    time_task_t task;
    uint32_t current_time = millis();

    task = time_node_find(current_time);    //æŸ¥æ‰¾å¾…æ‰§è¡Œä»»åŠ¡,å°†ä»»åŠ¡èŠ‚ç‚¹å–å‡º
    if (task == NULL)                       //æ— ä»»åŠ¡å¾…æ‰§è¡Œï¼Œåˆ™é€€å‡º 
    { return; }

    /*æ›´æ–°æ‰§è¡Œæ—¶é—´ï¼Œå°†ä»»åŠ¡èŠ‚ç‚¹é‡æ–°æ’å…¥*/
    if(task->flag == TIME_PERIODIC_TRIG)
    { time_task_start(task,0); }

    task->func(task->para);             //è¿è¡Œä»»åŠ¡
    
    if(task->flag == TIME_SINGLE_TRIG)  //åˆ é™¤å•æ¬¡ä»»åŠ¡
    { free(task); }
    
    return;
}
```

## ä½¿ç”¨å®ä¾‹
ä½¿ç”¨åŒæ ·çš„ä»»åŠ¡ï¼šæ¯10msåˆ·æ–°å±å¹•æ•°æ®ï¼Œæ¯20msæ£€æµ‹æŒ‰é”®çŠ¶æ€ï¼Œæ¯100msè¯»å–ä¼ æ„Ÿå™¨æ•°æ®ï¼Œç”µæœºæ¯1åˆ†é’Ÿè¿è¡Œ10såå…³é—­ã€‚

è¿è¡Œä»£ç å¦‚ä¸‹ï¼š
```c
#include "TimeSchedule.h"
#include <stdio.h>
#include <stdlib.h>

void func(void *arg)
{
    printf("Tick :%d, %s\n", millis(),arg);
}

void stop_motor(void *arg)
{
    printf("Tick :%d, åœæ­¢ç”µæœº\n", millis());
}

void run_motor(void * arg)
{
    time_task_t task;

    printf("Tick :%d, è¿è¡Œç”µæœº\n", millis());
    task = time_task_register(10000, stop_motor,NULL, TIME_SINGLE_TRIG);
    time_task_start(task, 0);
}

int main(int argc, char * argv[])
{
    time_task_t task;

    /*æ³¨å†Œä»»åŠ¡*/
    task = time_task_register(20, func, "æ£€æŸ¥æŒ‰é”®çŠ¶æ€", TIME_PERIODIC_TRIG);
    time_task_start(task, 0);
    task = time_task_register(100, func, "è¯»å–ä¼ æ„Ÿå™¨æ•°æ®", TIME_PERIODIC_TRIG);
    time_task_start(task, 0);
    task = time_task_register(60000, run_motor, NULL, TIME_PERIODIC_TRIG);
    time_task_start(task, 0);

    while (1)
    {
        /*è¿è¡Œè°ƒåº¦å™¨*/
        time_task_schedule();
    }

}
```

## è°ƒåº¦å™¨ä¼˜ç¼ºç‚¹
**ä¼˜ç‚¹**ï¼šå°†ç›¸åŒçš„ä»£ç å¤„ç†é€»è¾‘ï¼ŒæŠ½è±¡åå½¢æˆä¸€ä¸ªç»Ÿä¸€çš„æ‰§è¡Œæ¡†æ¶ï¼Œå¯ä»¥æé«˜ä»£ç å¤ç”¨æ€§ï¼Œç®€åŒ–ä»£ç ç»“æ„ã€‚

**ç¼ºç‚¹**ï¼šå½“å‰è°ƒåº¦å™¨åªèƒ½æ‰§è¡Œå°å‹ä»»åŠ¡ï¼ˆæ‰§è¡Œæ—¶é—´çŸ­ï¼‰ï¼Œå½“ä¸€ä¸ªä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´å¤§äºå…¶ä»–ä»»åŠ¡çš„æ‰§è¡Œé—´éš”æ—¶ï¼Œæ‰§è¡Œé¡ºåºæµå°†å‘é€å¼‚å¸¸ã€‚
ä¾‹å¦‚ï¼šä»»åŠ¡Aæ¯10msæ‰§è¡Œä¸€æ¬¡,æ‰§è¡Œç”¨æ—¶1msï¼›ä»»åŠ¡Bæ—¶ï¼Œæ¯1åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼Œéœ€è¦ç”¨æ—¶23msã€‚ä»»åŠ¡Aæ¯ä¸€åˆ†é’Ÿå°†å°‘æ‰§è¡Œä¸€æ¬¡ã€‚

è¿™ä¸ªé—®é¢˜çš„æ ¹æœ¬åœ¨äºåˆ†æ—¶è°ƒåº¦çš„æ‰§è¡Œä»¥ä»»åŠ¡ä¸ºå•ä½ï¼Œåœ¨æ‰§è¡Œä¸€ä¸ªä»»åŠ¡æ—¶ï¼Œå…¶ä»–ä»»åŠ¡æ— æ³•æŠ¢å å’Œåˆ‡æ¢ã€‚æ‰€ä»¥åœ¨ä»£ç è®¾è®¡çš„æ—¶å€™å°±éœ€è¦è€ƒè™‘åˆ°è¯¥é—®é¢˜çš„å­˜åœ¨ã€‚

---
æˆ‘å¼€é€šå¾®ä¿¡å…¬ä¼—å•¦ï¼Œåœ¨æˆ‘çš„å…¬ä¼—å·è¿˜æœ‰å¾ˆå¤šæ–‡ç« æ›´æ–°å“Ÿï¼Œæ’ç‰ˆä¹Ÿæ›´å¥½çœ‹ğŸ˜ï¼Œæ¬¢è¿å¤§å®¶å…³æ³¨
CSDNåšå®¢ï¼š[éå…¸å‹æŠ€æœ¯å®…](https://blog.csdn.net/mirco_mcu)  
ä¸ªäººå…¬ä¼—å·ï¼š  
![éå…¸å‹æŠ€æœ¯å®…](https://github.com/Gary-Hobson/Blog-Attachment/raw/master/picture/%E9%9D%9E%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%AE%85.jpg)
